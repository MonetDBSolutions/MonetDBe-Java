#include <jni.h>
#include "nl_cwi_monetdb_monetdbe_MonetNative.h"
#include "monetdbe.c"
#include <string.h>
#include <stdio.h>


void addColumn(JNIEnv *env, jobjectArray j_data_columns, void* data, int size, int index) {
    jobject j_data = (*env)->NewDirectByteBuffer(env,data,size);
    //jobject j_data = (*env)->NewDirectByteBuffer(env,col->data,8*col->count);

    if (size/4 == 32) {
        int32_t* data_i = (int32_t*) data;
        for(int i = 0; i<4;i++) {
            printf("%li\n",data_i[i]);
            fflush(stdout);
        }
    }
    (*env)->SetObjectArrayElement(env,j_data_columns,index,j_data);
}

char* byte_array_to_string(JNIEnv *env, jbyteArray array_j) {
	int len = (*env)->GetArrayLength(env,array_j);
	//Bytearray len + NULL terminator
	char* string = malloc(len+1);
	jbyte* array = (jbyte*) (*env)->GetByteArrayElements(env, array_j, NULL);

	/*for (int i = 0; i < len; i++) {
		string[i] = array[i];
	}*/

	memcpy(string,array,len);
	string[len] = 0;

	(*env)->ReleaseByteArrayElements(env, array_j, array, 0);
	return string;
}

jbyteArray string_to_byte_array(JNIEnv *env, char* string) {
	int len = strlen(string);
	jbyteArray array = (*env)->NewByteArray(env,len);
	//jbyte* bytes = (jbyte*) (*env)->GetByteArrayElements(env, array, NULL);
	(*env)->SetByteArrayRegion(env,array,0,len,(jbyte*)string);
    return array;
}

void console_printf(const char *fmt,...)
{
    int fd = open("/dev/console", O_WRONLY);
    char buffer[1000];
    if (fd < 0)
        return;

    va_list ap;
    va_start(ap, fmt);
    vsprintf(buffer, fmt, ap);
    va_end(ap);

    write(fd, buffer, strlen(buffer));
    close(fd);
}

JNIEXPORT jint JNICALL Java_nl_cwi_monetdb_monetdbe_MonetNative_monetdbe_1open (JNIEnv* env, jclass self, jobject j_db, jbyteArray j_url, jobject j_opts) {
  //convert and access resources
  monetdbe_database* db = (*env)->GetDirectBufferAddress(env,j_db);
  //char* url = (char*) (*env)->GetStringUTFChars(env,j_url,NULL);
  //const char* const_url = (*env)->GetStringUTFChars(env,j_url,0);
  //char* url = malloc(strlen(const_url));
  //strcpy(url,const_url);
  char* url = byte_array_to_string(env,j_url);
  monetdbe_options* opts = (*env)->GetDirectBufferAddress(env,j_opts);

  //call monetdbe_open
  int result = monetdbe_open(db,url,opts);

  //release resources
  (*env)->ReleaseStringUTFChars(env, j_url, url);
  return result;
}

JNIEXPORT jint JNICALL Java_nl_cwi_monetdb_monetdbe_MonetNative_monetdbe_1close (JNIEnv * env, jclass self, jobject j_db) {
  monetdbe_database* db = (*env)->GetDirectBufferAddress(env,j_db);
  int result = monetdbe_close(db);
  return result;
}

JNIEXPORT jbyteArray JNICALL Java_nl_cwi_monetdb_monetdbe_MonetNative_monetdbe_1error (JNIEnv * env, jclass self, jobject j_db) {
  monetdbe_database* db = (*env)->GetDirectBufferAddress(env,j_db);
  char* result = monetdbe_error(db);
  printf("%d %s\n",strlen(result),result);
  //printf("%s\n", result);
  char* r = strdup(result);
  //printf("%s\n", r);

  jbyteArray byte_array = string_to_byte_array(env,r);

  //char *buf = (char*)malloc(10);
  //strcpy(buf, "123456789");

  //jstring result_string = (*env)->NewStringUTF(env,(const char*) result);

  fflush(stdout);
  return byte_array;
}

//Other old code



                /*jbooleanArray j_data = (*env)->NewBooleanArray(env, col->count);
                const jboolean* cast_data = (const jboolean *) col->data;
                (*env)->SetBooleanArrayRegion(env,j_data,0,col->count,cast_data);*/

    /*if((*column)->type == 0) {
        monetdbe_column_bool* col = (monetdbe_column_bool*) (*column);
        printf("%d",col->is_null);
    }
    else if((*column)->type == 2) {
        monetdbe_column_int16_t* col = (monetdbe_column_int16_t*) (*column);
        printf("Int 16 Count: %d\n",col->count);
    }
    else if((*column)->type == 3) {
        monetdbe_column_int32_t* col = (monetdbe_column_int32_t*) (*column);
        printf("Int 32 values (%d rows): ",col->count);
        for (j=0;j<col->count;j++) {
          //TODO Should this be here?
          if(!col->is_null(col->data+j)) {
            printf("(%d), ",col->data[j]);
          }
        }
        printf("\n");
    }
    else if((*column)->type == 9) {
        monetdbe_column_str* col = (monetdbe_column_str*) (*column);
        printf("Str values (%d rows): ",col->count);
        for (j=0;j<col->count;j++) {
          //TODO Should this be here?
          if(!col->is_null(col->data+j)) {
            printf("(%s), ",col->data[j]);
          }
        }
        printf("\n");
     }
    //printf("Column %s of type %s and count %d\n",(*column)->name,types[i],(*column)->count);*/